@model List<NinhBinhStore.Models.RevenueViewModel>
@{
    ViewData["Title"] = "Báo cáo doanh thu";
    Layout = "_AdminLayout";

    // Chuẩn bị dữ liệu cho Chart.js
    var chartData = Model.OrderBy(x => DateTime.ParseExact(x.Ngay, "dd/MM/yyyy", null)).ToList();
    var labels = Newtonsoft.Json.JsonConvert.SerializeObject(chartData.Select(x => x.Ngay));
    var data = Newtonsoft.Json.JsonConvert.SerializeObject(chartData.Select(x => x.DoanhThu));
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a asp-action="Dashboard" class="text-decoration-none text-muted"><i class="fa-solid fa-arrow-left me-1"></i> Dashboard</a>
        <h3 class="fw-bold mt-1">Báo Cáo Doanh Thu</h3>
    </div>
    <a asp-action="ExportRevenue" class="btn btn-success shadow-sm">
        <i class="fa-solid fa-file-excel me-2"></i> Xuất Excel
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm bg-primary text-white rounded-4">
            <div class="card-body p-4">
                <h5>Tổng Doanh Thu Thực Tế</h5>
                <h2 class="fw-bold">@(((decimal)ViewBag.TotalRevenue).ToString("N0")) đ</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm bg-info text-white rounded-4">
            <div class="card-body p-4">
                <h5>Tổng Đơn Hàng Hoàn Thành</h5>
                <h2 class="fw-bold">@ViewBag.TotalOrders đơn</h2>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-header bg-white py-3">
        <h6 class="fw-bold m-0 text-primary"><i class="fa-solid fa-chart-bar me-2"></i>Biểu đồ doanh thu theo ngày</h6>
    </div>
    <div class="card-body">
        <div style="height: 500px; width: 100%; max-width: 800px; margin: 0 auto; position: relative;">
        <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Đăng ký Plugin
        Chart.register(ChartDataLabels);

        const ctx = document.getElementById('revenueChart').getContext('2d');

        const labels = @Html.Raw(labels);
        const data = @Html.Raw(data);
        const orderCounts = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(chartData.Select(x => x.SoDonHang)));

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: data,
                    orderCounts: orderCounts, // Dữ liệu số đơn hàng (để hiển thị khi hover)
                    backgroundColor: 'rgba(13, 110, 253, 0.8)', // Màu xám đậm giống hình mẫu (hoặc để xanh tùy bạn)
                    borderColor: '#333',
                    borderWidth: 1,
                    borderRadius: 0, // Cột vuông vức giống hình mẫu
                    maxBarThickness: 50 // Độ rộng cột vừa phải
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 40 // Thêm khoảng trống bên trên để số không bị cắt mất
                    }
                },
                plugins: {
                    legend: { display: false }, // Ẩn chú thích bên dưới cho giống hình mẫu

                    // --- CẤU HÌNH SỐ HIỆN TRÊN ĐẦU CỘT ---
                    datalabels: {
                        anchor: 'end', // Neo ở đỉnh cột
                        align: 'end',  // Đẩy lên phía trên đỉnh
                        color: '#000', // Màu chữ đen
                        font: {
                            weight: 'bold',
                            size: 13
                        },
                        formatter: function(value) {
                            // Format số tiền: 27.100 hoặc 8.400.000
                            return new Intl.NumberFormat('vi-VN').format(value);
                        }
                    },
                    // ---------------------------------------

                    // Vẫn giữ Tooltip hiển thị số đơn hàng khi trỏ chuột vào
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let revenue = context.parsed.y;
                                let revenueStr = new Intl.NumberFormat('vi-VN').format(revenue) + ' đ';
                                let count = context.dataset.orderCounts[context.dataIndex];
                                return [
                                    `Doanh thu: ${revenueStr}`,
                                    `Số đơn hàng: ${count}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        // Ẩn lưới ngang dọc để giống hình mẫu hơn (nếu muốn)
                        grid: { display: true, drawBorder: true },
                        ticks: {
                            stepSize: 10000000, // Bước nhảy 10 triệu
                            callback: function(value) {
                                return (value / 1000000) + ' tr'; // Rút gọn trục Y cho gọn
                            }
                        }
                    },
                    x: {
                        grid: { display: false } // Ẩn lưới dọc
                    }
                }
            }
        });
    });
</script>